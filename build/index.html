<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Polopoly</title>
	<script src="http://nature.com/view/scripts/jquery/jquery-1.7.2.min.js" type="text/javascript"></script>
	<!-- <script src="https://poly-admin1.nature.com/polopoly_static/js/jquery-1.6.4.js" type="text/javascript"></script> -->

	<link rel="stylesheet" type="text/css" href="polopoly/reset.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/html5.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/layout.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/header.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/footer.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/news-main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/comments.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/mobile.css" />	
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=2.2,user-scalable=yes"/>


</head>


<!--[if lt IE 6]><body class="lt-ie6"><![endif]-->
<!--[if IE 6]><body class="ie6"><![endif]-->
<!--[if IE 7]><body class="ie7"><![endif]-->
<!--[if IE 8]><body class="ie8"><![endif]-->
<!--[if gt IE 8]><body class="gt-ie8"><![endif]-->
<!--[if !IE]>--><body><!--<![endif]-->

<div id="constrain">

<div id="main">
	<div id="constrain-content" class="cleared">
		<div id="content" class="col">
			<article>
				<div id="article">
					<section>
						<div class="section">
							<div class="html-widget img-rigth">

<!-- ========= PASTED POLOPOLY HEADER ABOVE ========= -->







<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
}

.outerwrapper {
  width: 100%;
  min-height: 900px;
  position: relative;
  border: 1px solid #c8c7cf;
}
.outerwrapper h2, .outerwrapper h3, .outerwrapper p {
  padding: 10px 10px 0 10px;
  margin: 0;
}
.outerwrapper #chart {
  height: 500px;
}
.outerwrapper .node rect {
  cursor: move;
  fill-opacity: 0.9;
  shape-rendering: crispEdges;
}
.outerwrapper .node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}
.outerwrapper .link {
  fill: none;
  stroke-opacity: 0.2;
}
.outerwrapper .link:hover {
  stroke-opacity: 0.8;
}

</style>
<div class="outerwrapper">
	<p>I hope this works!</p>
	<div id="chart"></div>
</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function resize () {
	// if($(window).width() != width){
	// 	width = $(window).width();
	// 	console.log("We're resizing!");
	// }
}
function buildGraphic (data) {

	console.log(data);

	var margin = {top: 1, right: 1, bottom: 6, left: 1},
		width = 630 - margin.left - margin.right,
		height = 500 - margin.top - margin.bottom;

	var formatNumber = d3.format(",.0f"),
		format = function(d) { return formatNumber(d) + " TWh"; },
		color = d3.scale.category20();

	var svg = d3.select("#chart").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
	  .append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


	var gradient = svg.append("svg:defs")
	  .append("svg:linearGradient")
	    .attr("id", "gradient")
	    .attr("gradientUnits","userSpaceOnUse");

	gradient.append("svg:stop")
	    .attr("offset", "0%")
	    .attr("stop-color", "#0c0")
	    .attr("stop-opacity", 1);

	gradient.append("svg:stop")
	    .attr("offset", "100%")
	    .attr("stop-color", "#c00")
	    .attr("stop-opacity", 1);

	var sankey = d3.sankey()
		.nodeWidth(15)
		.nodePadding(10)
		.size([width, height]);

	var path = sankey.link();

 	sankey
		.nodes(data.nodes)
		.links(data.links)
		.layout(32);

	var link = svg.append("g").selectAll(".link")
		  .data(data.links)
		.enter().append("path")
		  .attr("class", "link")
		  .attr("d", path)
		  // .attr("stroke", function (d) {
		  // 	console.log(d);
		  // 	return "url(#gradient)";
		  // })
		  .attr("stroke","url(#gradient)")
		  .style("stroke-width", function(d) { return Math.max(1, d.dy); })
		  .sort(function(a, b) { return b.dy - a.dy; });

	link.append("title")
		.text(function(d) {
			return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value);
		});
	
	var node = svg.append("g").selectAll(".node")
		  .data(data.nodes)
		.enter().append("g")
		  .attr("class", "node")
		  .attr("transform", function(d) {
		  	return "translate(" + d.x + "," + d.y + ")";
		  })
		.call(
			d3.behavior.drag()
			  .origin(function(d) { 
			  	return d;
			  })
			  .on("dragstart", function() { this.parentNode.appendChild(this); })
			  .on("drag", dragmove)
			);

	node.append("rect")
		.attr("height", function(d) { return d.dy; })
		.attr("width", sankey.nodeWidth())
		.style("fill", function(d) { 
			return d.colour;
		})
		.style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
	  .append("title")
		.text(function(d) { return d.name + "\n" + format(d.value); });

	function dragmove(d) {
		d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
		sankey.relayout();
		link.attr("d", path);
	}

	  node.append("text")
		  .attr("x", -6)
		  .attr("y", function(d) { return d.dy / 2; })
		  .attr("dy", ".35em")
		  .attr("text-anchor", "end")
		  .attr("transform", null)
		  .text(function(d) { return d.name; })
		.filter(function(d) { return d.x < width / 2; })
		  .attr("x", 6 + sankey.nodeWidth())
		  .attr("text-anchor", "start");

}

(function() {
	var init = function($) {
		// var d3URL = "http://www.nature.com/widget_assets_polopoly/v518n7538/d3.v3.min.js";

		var dataURL = "data/energy6.json";
		var d3URL = "js/d3.v3.min.js";
		var sankeyURL = "js/sankey.js";

		$.when( $.getScript(d3URL),
				$.getScript(sankeyURL)
		).then( function () {

			/*	Load the data in parallel */
			/*	https://groups.google.com/forum/#!msg/d3-js/3Y9VHkOOdCM/YnmOPopWUxQJ */
			var data;
			var remaining = 1;
			var width = $(window).width();

			d3.json(dataURL, function (error, d) {
				if (error) {
					$(".widget-error-message").css("display","block");
				} else {
					data = d;
					if (!--remaining) buildGraphic(d);
				}
			});

			window.onresize = resize;

		}, function (error) {
			$(".widget-error-message").css("display","block");
			console.log("It's not loaded!");

		});


	/* End of active code */
	};

	setTimeout(function() {
		if (typeof jQuery !== 'undefined') {
			/*	jQuery ready test for svg */
			if ( document.implementation.hasFeature('http://www.w3.org/TR/SVG11/feature#Image','1.1') ) {
				init(jQuery);
			} else {
				jQuery(".widget-status-message").css("display","block");
			}
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);

})();
</script>
<!--<![endif]-->
<!-- ========= PASTED POLOPOLY FOOTER BELOW ========= -->

</div>							
						</div>
					</section>
				</div>
			</article>
		</div>
	</div>
</div>
</div>
</body>
</html>